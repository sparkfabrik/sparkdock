name: Notify Slack on Master Merge

on:
  push:
    branches:
      - master
    paths:
      - 'CHANGELOG.md'

jobs:
  notify-slack:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 2  # Fetch current and previous commit

      - name: Get changelog diff
        id: changelog-diff
        run: |
          # Get the diff of CHANGELOG.md from the previous commit
          DIFF=$(git diff HEAD~1 HEAD -- CHANGELOG.md)

          # Check if there are any changes
          if [ -z "$DIFF" ]; then
            echo "No changelog changes detected"
            echo "has_changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "has_changes=true" >> $GITHUB_OUTPUT

          # Save the diff to a file for the next step
          echo "$DIFF" > /tmp/changelog-diff.txt

          # Also save just the added lines (features)
          echo "$DIFF" | grep "^+" | grep -v "^+++" > /tmp/changelog-added.txt || true

      - name: Analyze changelog with Claude
        id: analyze-changelog
        if: steps.changelog-diff.outputs.has_changes == 'true'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          # Read the changelog diff
          CHANGELOG_DIFF=$(cat /tmp/changelog-diff.txt)

          # Create a prompt for Claude to analyze the changelog
          PROMPT="You are analyzing a CHANGELOG.md diff for a macOS development environment provisioner called Sparkdock.

          Your task is to:
          1. Determine if the changes contain significant NEW FEATURES that would be valuable to announce to users
          2. Ignore minor bug fixes, small improvements, or internal changes
          3. If there ARE significant features worth announcing, respond with JSON: {\"should_notify\": true, \"message\": \"<your message>\"}
          4. If there are NO significant features, respond with JSON: {\"should_notify\": false}

          Guidelines for the message (if should_notify is true):
          - Keep it concise (2-4 sentences maximum)
          - Focus on user-facing benefits
          - Use friendly, conversational tone
          - Highlight the most impactful features
          - Mention this is merged into the master branch
          - Do NOT include markdown formatting or headers

          Here is the CHANGELOG.md diff:

          \`\`\`diff
          ${CHANGELOG_DIFF}
          \`\`\`

          Respond ONLY with valid JSON, no other text."

          # Call Claude API
          RESPONSE=$(curl -s -X POST https://api.anthropic.com/v1/messages \
            -H "Content-Type: application/json" \
            -H "x-api-key: ${ANTHROPIC_API_KEY}" \
            -H "anthropic-version: 2023-06-01" \
            -d @- << EOF
          {
            "model": "claude-3-5-sonnet-20241022",
            "max_tokens": 1024,
            "messages": [
              {
                "role": "user",
                "content": $(echo "$PROMPT" | jq -Rs .)
              }
            ]
          }
          EOF
          )

          # Extract the response text
          CLAUDE_RESPONSE=$(echo "$RESPONSE" | jq -r '.content[0].text')

          # Parse the JSON response from Claude
          SHOULD_NOTIFY=$(echo "$CLAUDE_RESPONSE" | jq -r '.should_notify')
          MESSAGE=$(echo "$CLAUDE_RESPONSE" | jq -r '.message // ""')

          echo "should_notify=${SHOULD_NOTIFY}" >> $GITHUB_OUTPUT

          # Save message to file if we should notify
          if [ "$SHOULD_NOTIFY" = "true" ]; then
            echo "$MESSAGE" > /tmp/slack-message.txt
            echo "Generated message:"
            cat /tmp/slack-message.txt
          else
            echo "No significant features detected - skipping notification"
          fi

      - name: Send Slack notification
        if: steps.analyze-changelog.outputs.should_notify == 'true'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          # Read the message generated by Claude
          MESSAGE=$(cat /tmp/slack-message.txt)

          # Get commit info
          COMMIT_SHA="${GITHUB_SHA:0:7}"
          COMMIT_URL="https://github.com/${GITHUB_REPOSITORY}/commit/${GITHUB_SHA}"
          AUTHOR="${GITHUB_ACTOR}"

          # Create Slack message payload with blocks for better formatting
          PAYLOAD=$(jq -n \
            --arg text "üéâ New Sparkdock features merged to master!" \
            --arg message "$MESSAGE" \
            --arg commit_url "$COMMIT_URL" \
            --arg commit_sha "$COMMIT_SHA" \
            --arg author "$AUTHOR" \
            '{
              "text": $text,
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "üéâ New Sparkdock Features",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": $message
                  }
                },
                {
                  "type": "context",
                  "elements": [
                    {
                      "type": "mrkdwn",
                      "text": ("*Commit:* <" + $commit_url + "|" + $commit_sha + "> by " + $author)
                    }
                  ]
                }
              ]
            }')

          # Send to Slack
          HTTP_STATUS=$(curl -s -o /tmp/slack-response.txt -w "%{http_code}" \
            -X POST \
            -H 'Content-Type: application/json' \
            -d "$PAYLOAD" \
            "${SLACK_WEBHOOK_URL}")

          if [ "$HTTP_STATUS" = "200" ]; then
            echo "‚úÖ Slack notification sent successfully"
          else
            echo "‚ùå Failed to send Slack notification. HTTP status: $HTTP_STATUS"
            cat /tmp/slack-response.txt
            exit 1
          fi
