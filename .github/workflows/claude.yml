name: Claude Code

on:
    issue_comment:
        types: [created]
    pull_request_review_comment:
        types: [created]
    issues:
        types: [opened, assigned]
    pull_request_review:
        types: [submitted]

jobs:
    claude:
        if: |
            (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
            (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
            (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
            (github.event_name == 'issues' && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude')))
        runs-on: ubuntu-latest
        timeout-minutes: 15
        permissions:
            contents: write
            pull-requests: write
            issues: write
            id-token: write
            actions: read
        steps:
            - name: Checkout repository
              uses: actions/checkout@v6
              with:
                  fetch-depth: 1

            - name: Run Claude Code
              id: claude
              uses: anthropics/claude-code-action@v1
              with:
                  anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
                  track_progress: true
                  claude_args: |
                      --max-turns 20
                      --model claude-opus-4-6
                      --system-prompt "Follow Sparkdock project conventions from AGENTS.md and .github/copilot-instructions.md and .github/instructions/ directory."
                  settings: |
                      {
                        "permissions": {
                          "allow": [
                            "WebSearch",
                            "WebFetch(domain:opencode.ai)",
                            "WebFetch(domain:docs.docker.com)",
                            "WebFetch(domain:kubernetes.io)",
                            "WebFetch(domain:cloud.google.com)",
                            "WebFetch(domain:registry.terraform.io)",
                            "WebFetch(domain:docs.github.com)",
                            "WebFetch(domain:docs.gitlab.com)",
                            "WebFetch(domain:docs.ansible.com)",
                            "WebFetch(domain:helm.sh)",
                            "WebFetch(domain:docs.anthropic.com)",
                            "WebFetch(domain:code.claude.com)"
                          ]
                        }
                      }
